#!/usr/bin/env bash

GH_REPO="airbox-build/shipper"
TIMEOUT=90
DEFAULT_CONFIG_URL="https://raw.githubusercontent.com/airbox-build/shipper/refs/heads/main/shipper.yml"
CONFIG_PATH="/etc/airbox/shipper.yml"
BINARY_PATH="/usr/local/bin"
SERVICE_NAME="airbox-shipper"
BINARY_DIRECTORY=""

# Parse command line arguments
while [[ "$#" -gt 0 ]]; do
  case $1 in
    --config)
      CONFIG_PATH="$2"
      shift 2
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
done

# Determine the operating system and architecture
OS=$(uname -s | tr '[:upper:]' '[:lower:]')
ARCH=$(uname -m)

case "$ARCH" in
  x86_64 | amd64) ARCH="amd64" ;;
  i?86 | x86) ARCH="386" ;;
  aarch64 | arm64) ARCH="arm64" ;;
  *) echo "Unsupported architecture: ${ARCH}"; exit 2 ;;
esac

case "${OS}" in
  linux) BINARY_DIRECTORY="/opt/airbox" ;;
  darwin) BINARY_DIRECTORY="/usr/local/airbox" ;;
  *) echo "Unsupported OS: ${OS}"; exit 1 ;;
esac

# Create necessary directories
mkdir -p "${BINARY_DIRECTORY}" || exit 2
mkdir -p "/etc/airbox/" || exit 2

# Detect if running inside a container
is_container() {
  if [ -f /.dockerenv ] || [ -f /run/.containerenv ]; then
    return 0
  elif grep -q -i "container" /proc/1/cgroup 2>/dev/null; then
    return 0
  else
    return 1
  fi
}

# Fetch the latest version
VERSION=$(curl --silent --location --max-time "${TIMEOUT}" \
  "https://api.github.com/repos/${GH_REPO}/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
if [ -z "${VERSION}" ]; then
  echo "Error fetching the latest version. Please try again."
  exit 1
fi

# Download the binary
GH_REPO_BIN="shipper-${VERSION}-${OS}-${ARCH}.tar.gz"
TMP_DIR=$(mktemp -d 2>/dev/null || mktemp -d -t 'shipper-install.XXXXXXXXXX')
echo "Using temporary directory: ${TMP_DIR}"
cd "${TMP_DIR}"

echo "Downloading AirBox Shipper ${VERSION}..."
curl --silent --location --max-time "${TIMEOUT}" \
  "https://github.com/${GH_REPO}/releases/download/${VERSION}/${GH_REPO_BIN}" | tar zxf - || {
    echo "Error downloading binary."; exit 2;
}

# Install the binary
cp shipper "${BINARY_PATH}/${SERVICE_NAME}" || exit 2
chmod 755 "${BINARY_PATH}/${SERVICE_NAME}"

# Verify installation
if [ ! -f "${BINARY_PATH}/${SERVICE_NAME}" ]; then
  echo "Installation failed: ${SERVICE_NAME} not found."
  exit 2
fi

# Download config if it doesn't exist
if [ ! -f "${CONFIG_PATH}" ]; then
  echo "Downloading configuration file to ${CONFIG_PATH}..."
  sudo curl --silent --location --max-time "${TIMEOUT}" \
    "${DEFAULT_CONFIG_URL}" -o "${CONFIG_PATH}" || {
      echo "Error downloading config file."; exit 2;
  }
fi

rm -rf "${TMP_DIR}"
echo "Installed successfully to ${BINARY_PATH}/${SERVICE_NAME}."

# Function to create Supervisor config
create_supervisor_config() {
  echo "Setting up Supervisor..."
  sudo tee /etc/supervisor/conf.d/${SERVICE_NAME}.conf >/dev/null <<EOF
[program:${SERVICE_NAME}]
command=${BINARY_PATH}/${SERVICE_NAME} --config=${CONFIG_PATH}
autostart=true
autorestart=true
stderr_logfile=/var/log/${SERVICE_NAME}.err.log
stdout_logfile=/var/log/${SERVICE_NAME}.out.log
EOF
  sudo supervisorctl reread
  sudo supervisorctl update
}

# Function to create systemd service
create_systemd_service() {
  echo "Setting up systemd service..."
  sudo tee /etc/systemd/system/${SERVICE_NAME}.service >/dev/null <<EOF
[Unit]
Description=AirBox Shipper Service
After=network.target

[Service]
ExecStart=${BINARY_PATH}/${SERVICE_NAME} --config=${CONFIG_PATH}
WorkingDirectory=${BINARY_DIRECTORY}
Restart=always
User=${USER}

[Install]
WantedBy=multi-user.target
EOF
  sudo systemctl enable ${SERVICE_NAME}.service
  sudo systemctl start ${SERVICE_NAME}.service
}

# Function to create launchd plist for macOS
create_launchd_service() {
  echo "Setting up macOS launchd service..."
  PLIST_PATH="/Library/LaunchDaemons/com.airbox.shipper.plist"
  sudo tee "$PLIST_PATH" >/dev/null <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>Label</key>
  <string>com.airbox.shipper</string>
  <key>ProgramArguments</key>
  <array>
    <string>${BINARY_PATH}/${SERVICE_NAME}</string>
    <string>--config=${CONFIG_PATH}</string>
  </array>
  <key>WorkingDirectory</key>
  <string>${BINARY_DIRECTORY}</string>
  <key>KeepAlive</key>
  <true/>
  <key>RunAtLoad</key>
  <true/>
</dict>
</plist>
EOF
  sudo launchctl load "$PLIST_PATH"
}

# Install service based on environment
if is_container; then
  echo "Running inside a container. Using Supervisor or manual execution."
  if command -v supervisorctl >/dev/null 2>&1; then
    create_supervisor_config
  else
    echo "Supervisor not available. Running manually in the background."
    "${BINARY_PATH}/${SERVICE_NAME}" --config="${CONFIG_PATH}" &
  fi
elif [ "${OS}" == "linux" ]; then
  if command -v systemctl >/dev/null 2>&1; then
    create_systemd_service
  else
    create_supervisor_config
  fi
elif [ "${OS}" == "darwin" ]; then
  create_launchd_service
else
  echo "Unsupported environment. Run manually:"
  "${BINARY_PATH}/${SERVICE_NAME}" --config="${CONFIG_PATH}" &
fi

echo "AirBox Shipper service setup complete."
